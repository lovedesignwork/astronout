# Booking Reference System

## Overview
All bookings now use a sequential reference number system with the format `AST-237551`, starting from 237551 and incrementing by 1 for each new booking.

## Format
```
AST-237551
AST-237552
AST-237553
...
```

- **Prefix**: `AST-` (Astronout)
- **Starting Number**: 237551
- **Increment**: +1 for each new booking
- **No gaps**: Sequential numbering ensures no missing numbers

## Implementation Details

### Database Changes
- **Migration File**: `supabase/migrations/008_booking_reference_system.sql`
- **Sequence**: `booking_number_seq` starting at 237551
- **Trigger**: Automatically assigns reference on booking creation
- **Backfill**: Updates all existing bookings with new format

### How It Works

#### 1. Database Sequence
PostgreSQL sequence ensures atomic, sequential number generation:
```sql
CREATE SEQUENCE booking_number_seq START WITH 237551;
```

#### 2. Automatic Reference Generation
When a booking is created:
1. Database trigger fires before INSERT
2. Sequence generates next number (e.g., 237551)
3. Reference is formatted as `AST-237551`
4. Booking is saved with the reference

#### 3. Trigger Function
```sql
CREATE TRIGGER trigger_assign_booking_reference
  BEFORE INSERT ON bookings
  FOR EACH ROW
  EXECUTE FUNCTION assign_booking_reference();
```

### Code Changes

#### 1. Utils Function (`lib/utils.ts`)
Updated `generateBookingReference()` to return empty string:
```typescript
export function generateBookingReference(): string {
  // Return empty string - database trigger will assign the actual reference
  // Format will be: AST-237551, AST-237552, AST-237553, etc.
  return '';
}
```

The database trigger handles the actual reference generation, ensuring:
- No race conditions
- No duplicate references
- Sequential numbering
- Atomic operations

#### 2. Booking Creation (`lib/data/bookings.ts`)
Removed client-side reference generation:
```typescript
// Before:
const reference = generateBookingReference();

// After:
// Reference is auto-generated by database trigger
const { data: booking, error: bookingError } = await supabase
  .from('bookings')
  .insert({
    // reference field is omitted - database will assign it
    tour_id: payload.tourId,
    // ... other fields
  })
```

#### 3. Admin Booking Creation (`app/api/admin/bookings/route.ts`)
Same approach - let database handle reference:
```typescript
// Reference will be auto-generated by database trigger (AST-237551, AST-237552, etc.)
const { data: booking, error: bookingError } = await supabase
  .from('bookings')
  .insert({
    // reference field is omitted
    tour_id: tourId,
    // ... other fields
  })
```

## Database Functions

### 1. `generate_booking_reference()`
Generates the next booking reference:
```sql
SELECT generate_booking_reference();
-- Returns: 'AST-237551'
```

### 2. `get_current_booking_number()`
Returns the current sequence value:
```sql
SELECT get_current_booking_number();
-- Returns: 237551
```

### 3. `preview_next_booking_number()`
Preview the next booking reference without incrementing:
```sql
SELECT preview_next_booking_number();
-- Returns: 'AST-237552'
```

## Features

### ✅ Sequential Numbering
- Guaranteed sequential order
- No gaps in numbering
- Starts from 237551 as specified

### ✅ Thread-Safe
- PostgreSQL sequence ensures atomic operations
- No race conditions between concurrent bookings
- Safe for high-traffic scenarios

### ✅ Automatic Assignment
- No manual intervention needed
- Database trigger handles everything
- Works for both customer and admin bookings

### ✅ Backfill Support
- Existing bookings are automatically updated
- Maintains chronological order based on creation date

### ✅ Easy to Search
- Simple format: `AST-237551`
- Can search by full reference or partial number
- Indexed for fast lookups

## Usage Examples

### Creating a Booking (Customer)
```typescript
// In your booking creation code
const { booking, error } = await createBooking({
  tourId: 'tour-uuid',
  bookingDate: '2024-01-15',
  customerName: 'John Doe',
  customerEmail: 'john@example.com',
  // ... other fields
});

// booking.reference will be: "AST-237551"
```

### Creating a Booking (Admin)
```typescript
// Admin API endpoint
const response = await fetch('/api/admin/bookings', {
  method: 'POST',
  body: JSON.stringify({
    tourId: 'tour-uuid',
    bookingDate: '2024-01-15',
    customerName: 'Jane Smith',
    customerEmail: 'jane@example.com',
    // ... other fields
  })
});

const { booking } = await response.json();
// booking.reference will be: "AST-237552"
```

### Searching for a Booking
```typescript
// Search by reference
const { data } = await supabase
  .from('bookings')
  .select('*')
  .eq('reference', 'AST-237551')
  .single();

// Partial search
const { data } = await supabase
  .from('bookings')
  .select('*')
  .ilike('reference', '%237551%');
```

## Migration Instructions

To apply this feature to an existing database:

### 1. Run the Migration
```bash
# If using Supabase CLI
supabase db push

# Or apply the SQL directly in Supabase Dashboard
# Copy contents of supabase/migrations/008_booking_reference_system.sql
```

### 2. Verify Installation
```sql
-- Check current booking number
SELECT get_current_booking_number();

-- Preview next booking reference
SELECT preview_next_booking_number();

-- Check that trigger is installed
SELECT * FROM pg_trigger WHERE tgname = 'trigger_assign_booking_reference';
```

### 3. Test Booking Creation
Create a test booking through your application and verify:
- Reference is in format `AST-XXXXXX`
- Number is sequential
- No errors in booking creation

### 4. Verify Existing Bookings
```sql
-- Check that all bookings have new references
SELECT id, reference, created_at 
FROM bookings 
ORDER BY created_at DESC 
LIMIT 10;
```

## Troubleshooting

### Issue: Bookings Have Old Reference Format
**Solution**: Re-run the backfill section of the migration:
```sql
-- Manually backfill bookings
SELECT generate_booking_reference() FROM bookings;
```

### Issue: Duplicate References
**Solution**: This should never happen due to the sequence, but if it does:
```sql
-- Reset sequence to max existing number
SELECT setval('booking_number_seq', 
  (SELECT MAX(CAST(REPLACE(reference, 'AST-', '') AS INTEGER)) FROM bookings)
);
```

### Issue: Need to Change Starting Number
**Solution**: Alter the sequence:
```sql
-- Set to specific number (e.g., 300000)
SELECT setval('booking_number_seq', 300000);
```

## Display in UI

### Booking Confirmation Page
```tsx
<div>
  <h2>Booking Confirmed!</h2>
  <p>Your booking reference: <strong>{booking.reference}</strong></p>
  <p>Please save this reference for your records.</p>
</div>
```

### Admin Bookings List
```tsx
<table>
  <thead>
    <tr>
      <th>Reference</th>
      <th>Customer</th>
      <th>Date</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {bookings.map(booking => (
      <tr key={booking.id}>
        <td className="font-mono font-semibold">{booking.reference}</td>
        <td>{booking.customer_name}</td>
        <td>{booking.booking_date}</td>
        <td>{booking.status}</td>
      </tr>
    ))}
  </tbody>
</table>
```

### Voucher Page
```tsx
<div className="voucher">
  <h1>Tour Voucher</h1>
  <div className="reference">
    Booking Reference: {booking.reference}
  </div>
  {/* ... rest of voucher content */}
</div>
```

## Benefits

1. **Professional**: Clean, simple format that's easy to communicate
2. **Sequential**: Easy to track booking volume and growth
3. **Unique**: Guaranteed unique across all bookings
4. **Searchable**: Simple format makes searching easy
5. **Scalable**: Can handle millions of bookings
6. **Reliable**: Database-level generation ensures consistency
7. **No Conflicts**: Sequence prevents duplicate references

## Technical Notes

- References are stored as TEXT for flexibility
- Sequence is BIGINT, supporting up to 9,223,372,036,854,775,807 bookings
- Trigger fires BEFORE INSERT, ensuring reference is set before save
- Backfill preserves chronological order using `created_at`
- Empty string from `generateBookingReference()` triggers database assignment
- The `.select()` after `.insert()` returns the complete booking with reference

## Future Enhancements

Potential improvements:

1. **Custom Prefixes**: Different prefixes for different booking types (e.g., `AST-T-` for tours, `AST-P-` for packages)
2. **Date-Based**: Include year/month in reference (e.g., `AST-2024-01-237551`)
3. **Check Digit**: Add validation digit for error detection
4. **QR Code**: Generate QR codes from booking references
5. **Short URLs**: Create short URLs using booking reference
6. **Analytics**: Track booking volume by reference number ranges

## Security Considerations

- References are public identifiers (not sensitive)
- Voucher tokens are used for authentication (separate from reference)
- Sequential numbers don't expose business intelligence (starting from 237551)
- Database sequence is thread-safe and atomic
- Unique constraint prevents duplicates at database level




